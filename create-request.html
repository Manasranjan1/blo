<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blood Donor - Create Request</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü©∏</text></svg>">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="index.html" class="logo">ü©∏ <span>Blood Donor</span></a>
                <nav>
                    <ul class="nav-menu">
                        <li><a href="profile.html">Profile</a></li>
                        <li><a href="create-request.html">Create Request</a></li>
                        <li><a href="donor-dashboard.html">Donor Dashboard</a></li>
                        <li><a href="requester-dashboard.html">My Requests</a></li>
                    </ul>
                </nav>
                <div class="user-menu">
                    <div class="notification-icon" onclick="toggleNotifications()">
                        üîî
                        <span id="notification-badge" class="notification-badge hidden">0</span>
                    </div>
                    <button onclick="signOut()" class="btn btn-outline">Sign Out</button>
                </div>
            </div>
        </div>
    </header>

    <main class="main-content">
        <div class="container">
            <div class="card">
                <div class="card-header">
                    <h1 class="card-title">Create Blood Request</h1>
                    <p class="card-subtitle">Request blood from nearby donors</p>
                </div>

                <form id="request-form">
                    <div class="form-group">
                        <label for="blood-type" class="form-label">Blood Type Required *</label>
                        <select id="blood-type" class="form-select" required>
                            <option value="">Select blood type</option>
                            <option value="A+">A+</option>
                            <option value="A-">A-</option>
                            <option value="B+">B+</option>
                            <option value="B-">B-</option>
                            <option value="AB+">AB+</option>
                            <option value="AB-">AB-</option>
                            <option value="O+">O+</option>
                            <option value="O-">O-</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="urgency" class="form-label">Urgency Level *</label>
                        <select id="urgency" class="form-select" required>
                            <option value="">Select urgency level</option>
                            <option value="Normal">Normal</option>
                            <option value="Urgent">Urgent</option>
                        </select>
                        <small style="color: #7f8c8d; font-size: 0.9rem;">
                            Urgent requests will be prioritized and highlighted to donors
                        </small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Request Location *</label>
                        <div id="location-section">
                            <button type="button" id="use-profile-location-btn" class="btn btn-secondary">
                                üìç Use Profile Location
                            </button>
                            <button type="button" id="detect-current-location-btn" class="btn btn-outline">
                                üìç Use Current Location
                            </button>
                            <div id="location-status" class="mt-2"></div>
                        </div>
                        <div id="location-details" class="hidden">
                            <div class="flex gap-2 mt-2">
                                <input type="number" id="latitude" class="form-input" placeholder="Latitude" step="any" readonly>
                                <input type="number" id="longitude" class="form-input" placeholder="Longitude" step="any" readonly>
                            </div>
                            <div id="address-display" class="mt-2 p-2" style="background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;"></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="additional-notes" class="form-label">Additional Notes</label>
                        <textarea id="additional-notes" class="form-input" rows="3" 
                                  placeholder="Any additional information about your request (optional)"></textarea>
                    </div>

                    <div class="form-group">
                        <button type="submit" id="create-request-btn" class="btn btn-primary" style="width: 100%;">
                            Create Blood Request
                        </button>
                    </div>
                </form>

                <div id="alert-container"></div>
            </div>

            <!-- Request Preview -->
            <div id="request-preview" class="card hidden">
                <div class="card-header">
                    <h2 class="card-title">Request Preview</h2>
                    <p class="card-subtitle">Review your request before submitting</p>
                </div>
                <div id="preview-content"></div>
            </div>
        </div>
    </main>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-messaging-compat.js"></script>
    
    <!-- App Scripts -->
    <script src="firebaseConfig.js"></script>
    <script src="geoFirestore.js"></script>
    <script src="auth.js"></script>
    <script src="requests.js"></script>
    <script src="notifications.js"></script>
    
    <script>
        // DOM elements
        const requestForm = document.getElementById('request-form');
        const bloodTypeSelect = document.getElementById('blood-type');
        const urgencySelect = document.getElementById('urgency');
        const useProfileLocationBtn = document.getElementById('use-profile-location-btn');
        const detectCurrentLocationBtn = document.getElementById('detect-current-location-btn');
        const locationStatus = document.getElementById('location-status');
        const locationDetails = document.getElementById('location-details');
        const latitudeInput = document.getElementById('latitude');
        const longitudeInput = document.getElementById('longitude');
        const addressDisplay = document.getElementById('address-display');
        const additionalNotesInput = document.getElementById('additional-notes');
        const createRequestBtn = document.getElementById('create-request-btn');
        const alertContainer = document.getElementById('alert-container');
        const requestPreview = document.getElementById('request-preview');
        const previewContent = document.getElementById('preview-content');

        let requestLocation = null;
        let userProfile = null;

        // Show alert message
        function showAlert(message, type = 'info') {
            alertContainer.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                alertContainer.innerHTML = '';
            }, 5000);
        }

        // Check if user is authenticated and has profile
        async function checkAuthAndProfile() {
            if (!window.authModule.isAuthenticated()) {
                window.location.href = 'index.html';
                return;
            }

            try {
                const user = window.authModule.getCurrentUser();
                const doc = await window.db.collection('users').doc(user.uid).get();
                
                if (!doc.exists) {
                    showAlert('Please complete your profile first', 'error');
                    setTimeout(() => {
                        window.location.href = 'profile.html';
                    }, 2000);
                    return;
                }

                userProfile = doc.data();
                if (!userProfile.location) {
                    showAlert('Please set your location in profile first', 'error');
                    setTimeout(() => {
                        window.location.href = 'profile.html';
                    }, 2000);
                    return;
                }

                // Set default location to profile location
                requestLocation = userProfile.location;
                updateLocationDisplay();
                
            } catch (error) {
                console.error('Error checking profile:', error);
                showAlert('Error loading profile. Please try again.', 'error');
            }
        }

        // Update location display
        function updateLocationDisplay() {
            if (requestLocation) {
                latitudeInput.value = requestLocation.lat;
                longitudeInput.value = requestLocation.lng;
                locationDetails.style.display = 'block';
                getAddressFromCoordinates(requestLocation.lat, requestLocation.lng);
            }
        }

        // Use profile location
        useProfileLocationBtn.addEventListener('click', () => {
            if (userProfile && userProfile.location) {
                requestLocation = userProfile.location;
                updateLocationDisplay();
                locationStatus.innerHTML = '<div class="alert alert-success">Using profile location</div>';
                updateRequestPreview();
            } else {
                showAlert('Profile location not available', 'error');
            }
        });

        // Detect current location
        detectCurrentLocationBtn.addEventListener('click', () => {
            if (!navigator.geolocation) {
                showAlert('Geolocation is not supported by your browser', 'error');
                return;
            }

            detectCurrentLocationBtn.disabled = true;
            detectCurrentLocationBtn.innerHTML = '<span class="loading"></span> Detecting...';
            locationStatus.innerHTML = '<div class="alert alert-info">Detecting your current location...</div>';

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    requestLocation = { lat: latitude, lng: longitude };
                    
                    updateLocationDisplay();
                    locationStatus.innerHTML = '<div class="alert alert-success">Current location detected!</div>';
                    detectCurrentLocationBtn.disabled = false;
                    detectCurrentLocationBtn.innerHTML = 'üìç Use Current Location';
                    updateRequestPreview();
                },
                (error) => {
                    console.error('Error getting location:', error);
                    let errorMessage = 'Failed to detect current location.';
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = 'Location permission denied. Please enable location access.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = 'Current location information unavailable.';
                            break;
                        case error.TIMEOUT:
                            errorMessage = 'Location request timed out.';
                            break;
                    }
                    
                    locationStatus.innerHTML = `<div class="alert alert-error">${errorMessage}</div>`;
                    detectCurrentLocationBtn.disabled = false;
                    detectCurrentLocationBtn.innerHTML = 'üìç Use Current Location';
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                }
            );
        });

        // Get address from coordinates
        async function getAddressFromCoordinates(lat, lng) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`);
                const data = await response.json();
                
                if (data.display_name) {
                    addressDisplay.textContent = data.display_name;
                } else {
                    addressDisplay.textContent = `Latitude: ${lat}, Longitude: ${lng}`;
                }
            } catch (error) {
                console.error('Error getting address:', error);
                addressDisplay.textContent = `Latitude: ${lat}, Longitude: ${lng}`;
            }
        }

        // Update request preview
        function updateRequestPreview() {
            if (!requestLocation) return;

            const bloodType = bloodTypeSelect.value;
            const urgency = urgencySelect.value;
            const notes = additionalNotesInput.value.trim();

            if (bloodType && urgency) {
                previewContent.innerHTML = `
                    <div class="request-card">
                        <div class="request-header">
                            <span class="request-type ${urgency.toLowerCase()}">${urgency}</span>
                            <span class="request-distance">Profile Location</span>
                        </div>
                        <div class="request-details">
                            <div class="request-blood-type">${bloodType}</div>
                            <div class="request-location">${addressDisplay.textContent || 'Location set'}</div>
                            ${notes ? `<div class="request-notes mt-2"><strong>Notes:</strong> ${notes}</div>` : ''}
                        </div>
                    </div>
                `;
                requestPreview.style.display = 'block';
            }
        }

        // Form change listeners for preview
        bloodTypeSelect.addEventListener('change', updateRequestPreview);
        urgencySelect.addEventListener('change', updateRequestPreview);
        additionalNotesInput.addEventListener('input', updateRequestPreview);

        // Handle form submission
        requestForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!requestLocation) {
                showAlert('Please set a location for your request', 'error');
                return;
            }

            const formData = {
                blood_type: bloodTypeSelect.value,
                urgency: urgencySelect.value,
                location: requestLocation,
                additional_notes: additionalNotesInput.value.trim(),
                created_at: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                createRequestBtn.disabled = true;
                createRequestBtn.innerHTML = '<span class="loading"></span> Creating Request...';
                
                const requestId = await window.requestsModule.createRequest(formData);
                
                showAlert('Blood request created successfully! Notifying nearby donors...', 'success');
                
                // Redirect to requester dashboard
                setTimeout(() => {
                    window.location.href = 'requester-dashboard.html';
                }, 2000);
                
            } catch (error) {
                console.error('Error creating request:', error);
                showAlert('Failed to create request. Please try again.', 'error');
            } finally {
                createRequestBtn.disabled = false;
                createRequestBtn.innerHTML = 'Create Blood Request';
            }
        });

        // Sign out function
        function signOut() {
            window.authModule.signOut();
        }

        // Toggle notifications
        function toggleNotifications() {
            // TODO: Implement notification panel
            alert('Notifications feature coming soon!');
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            checkAuthAndProfile();
        });
    </script>
</body>
</html> 